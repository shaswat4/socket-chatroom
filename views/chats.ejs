<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    Chats
  </title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <link rel="stylesheet" href="stylesheets\chat.css">
  <link rel="stylesheet" href="/stylesheets/style.css" />  

</head>

<body>

  <%- include("partials/navbar") %>

    <div class="current-user" hidden  ></div>

    <section>
      <div class="chat-nav">
        <div class="chat-header">
          <!-- contain search and other actions -->
          <h1>Chats</h1>
          <form action="/chat/search" method="post" class="chat-search">
            <input type="text" class="chat-search-input" name="query">
          </form>
        </div>

        <div class="chat-nav-body">
          <!-- contain chat list and will dynamically reload on searching-->
          <ul>
            <h1>safgiks</h1>
          </ul>
        </div>


      </div>
    </section>
    <section>
      <div class="chat-main">
        <div class="chat-main-header"></div>
        <div class="chat-main-body"></div>
        <div class="chat-main-input" >
          <form id="send-message-form" action="">
            <input id="input" autocomplete="off" />
            <button type="submit">Send</button>
          </form>          
        </div>
      </div>
    </section>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script >
      var socket = io();

      var messages = document.getElementById("messages");
      var form = document.getElementById("form");
      var input = document.getElementById("input");
      var room_id = null ;
      
      var other_user = null ;

      const active_user_id = null ; //logged_user.id ;

      //search and main chat body loading 
      $(document).ready(function () {

        function simpleMsgRender(msg) {
          var item = document.createElement('li');
          if (username === msg.username) {
            item.className = 'self';
          } else {
            item.className = 'other';
          }
          item.innerHTML = '<span>' + msg.username + '</span> : ' + msg.message;
          messages.appendChild(item);
          window.scrollTo(0, document.body.scrollHeight);
        }

        function renderChats( obj ) {

          if ( obj.chats.length >0 ){
            for (let index = 0; index < obj.chats.length; index++) {
              const element = obj.chats[index];
              simpleMsgRender(msg);
            }
          }
          

          // $(".chat-main-body").html(data);
        }

        function renderChatMain(obj) {

          let header =  "<h1>"+ obj.user.username +"</h1>"
          $(".chat-main-header").html(header);
          
          renderChats(obj);
        }

        // sets another user id and calls loadchatmain
        // when user is clicked
        function handleClickOnItem() {
          var value = $(this).attr("value");
          
          $.ajax({
            url: "chat/getMessage",
            type: "POST",
            data: { user_id: value },
            success: function (data) {
              // Handle the response from the server
              console.log(data);
              renderChatMain(data);
              //$(".chat-main-body").html(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              // Handle errors
              console.log("Error: " + textStatus + " - " + errorThrown);
            },
          });

          console.log("Value:", value);
          other_user = value ;
        }

        // when user searches gives result in html with list
        $(".chat-search").submit(function (e) {
          e.preventDefault();
          let a = $(".chat-search-input").val();
          console.log(a);

          $.ajax({
            url: "chat/search",
            type: "POST",
            data: { query: a },
            success: function (data) {
              // Handle the response from the server
              console.log(data);
              $(".chat-nav-body").html(data);
              $(".chat-nav-items").click(handleClickOnItem);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              // Handle errors
              console.log("Error: " + textStatus + " - " + errorThrown);
            },
          });
        });
      });


      //chat message 2 emitor
      $("send-message-form").submit(function (e) {
        console.log('dfaghjkl');
        e.preventDefault();
        if (input.value) {

          //created new group and/or get user id
          // intsert into room
          $.ajax({
            url: "chat/creatGroup",
            type: "POST",
            data: { user_id : other_user },
            success: function (data) {
              // Handle the response from the server
              room_id = data ;
              console.log(data);

            },
            error: function (jqXHR, textStatus, errorThrown) {
              // Handle errors
              console.log("Error: " + textStatus + " - " + errorThrown);
            },
          });
          
          socket.emit("chat message 2", {
            room: room_id ,
            message: input.value,
            user_id: "<%= user.id %>",
          });
          console.log(input.value);
          input.value = "";
        }
      });

      //chat group messge recievor 
      socket.on("chat group message", function (msg) {
        var item = document.createElement('li');
        if (username === msg.username) {
          item.className = 'self';
        } else {
          item.className = 'other';
        }
        item.innerHTML = '<span>' + msg.username + '</span> : ' + msg.message;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);

        //message_display(msg)
        //createMessageHTML(msg);
      });

    </script>

</body>

</html>